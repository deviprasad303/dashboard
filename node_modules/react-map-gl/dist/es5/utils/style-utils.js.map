{"version":3,"sources":["../../../src/utils/style-utils.js"],"names":["getInteractiveLayerIds","mapStyle","interactiveLayerIds","has","get","filter","l","map","toJS","Array","isArray","layers","interactive","id","setDiffStyle","prevStyle","nextStyle","prevKeysMap","styleKeysMap","nextKeysMap","style","delete","propsOtherThanLayersOrSourcesDiffer","prevKeysList","Object","keys","nextKeysList","length","some","key","setStyle","sourcesDiff","layersDiff","checkForEqualLayerSourceChanges","exit","applySourceLayerChanges","updateStyleSource","update","newSource","source","type","oldSource","getSource","oldOpts","workerOptions","scale","geojsonVtOptions","extent","maxzoom","undefined","maxZoom","buffer","tolerance","cluster","clusterRadius","superclusterOptions","radius","clusterMaxZoom","setData","data","removeSource","addSource","updates","node","layer","enter","exiting","getLayer","removeLayer","addLayer","before","sourceExit","nextLayers","sourceIds","s","layersNotRemoved","includes","lyr","size","Error","join"],"mappings":";;;;;;;;AAAA;;AACA;;;;AAEO,SAASA,sBAAT,CAAgCC,QAAhC,EAA0C;AAC/C,MAAIC,sBAAsB,IAA1B;;AAEA,MAAI,6BAAeD,QAAf,KAA4BA,SAASE,GAAT,CAAa,QAAb,CAAhC,EAAwD;AACtDD,0BAAsBD,SAASG,GAAT,CAAa,QAAb,EACnBC,MADmB,CACZ;AAAA,aAAKC,EAAEF,GAAF,CAAM,aAAN,CAAL;AAAA,KADY,EAEnBG,GAFmB,CAEf;AAAA,aAAKD,EAAEF,GAAF,CAAM,IAAN,CAAL;AAAA,KAFe,EAGnBI,IAHmB,EAAtB;AAID,GALD,MAKO,IAAIC,MAAMC,OAAN,CAAcT,SAASU,MAAvB,CAAJ,EAAoC;AACzCT,0BAAsBD,SAASU,MAAT,CAAgBN,MAAhB,CAAuB;AAAA,aAAKC,EAAEM,WAAP;AAAA,KAAvB,EACnBL,GADmB,CACf;AAAA,aAAKD,EAAEO,EAAP;AAAA,KADe,CAAtB;AAED;;AAED,SAAOX,mBAAP;AACD,C,CAED;AACA;AACA;;AACA;;;AACO,SAASY,YAAT,CAAsBC,SAAtB,EAAiCC,SAAjC,EAA4CT,GAA5C,EAAiD;AACtD,MAAMU,cAAcF,aAAaG,aAAaH,SAAb,CAAb,IAAwC,EAA5D;AACA,MAAMI,cAAcD,aAAaF,SAAb,CAApB;;AACA,WAASE,YAAT,CAAsBE,KAAtB,EAA6B;AAC3B,WAAOA,MAAMb,GAAN,CAAU;AAAA,aAAM,IAAN;AAAA,KAAV,EAAsBc,MAAtB,CAA6B,QAA7B,EAAuCA,MAAvC,CAA8C,SAA9C,EAAyDb,IAAzD,EAAP;AACD;;AACD,WAASc,mCAAT,GAA+C;AAC7C,QAAMC,eAAeC,OAAOC,IAAP,CAAYR,WAAZ,CAArB;AACA,QAAMS,eAAeF,OAAOC,IAAP,CAAYN,WAAZ,CAArB;;AACA,QAAII,aAAaI,MAAb,KAAwBD,aAAaC,MAAzC,EAAiD;AAC/C,aAAO,IAAP;AACD,KAL4C,CAM7C;;;AACA,QAAID,aAAaE,IAAb,CACF;AAAA,aAAOb,UAAUX,GAAV,CAAcyB,GAAd,MAAuBb,UAAUZ,GAAV,CAAcyB,GAAd,CAA9B;AAAA,KADE,CAEF;AAFE,KAAJ,EAGG;AACD,aAAO,IAAP;AACD;;AACD,WAAO,KAAP;AACD;;AAED,MAAI,CAACd,SAAD,IAAcO,qCAAlB,EAAyD;AACvDf,QAAIuB,QAAJ,CAAad,UAAUR,IAAV,EAAb;AACA;AACD;;AAzBqD,oBA2BpB,0BAAWO,SAAX,EAAsBC,SAAtB,CA3BoB;AAAA,MA2B/Ce,WA3B+C,eA2B/CA,WA3B+C;AAAA,MA2BlCC,UA3BkC,eA2BlCA,UA3BkC;;AA4BtDC,kCAAgCF,YAAYG,IAA5C,EAAkDlB,UAAUZ,GAAV,CAAc,QAAd,CAAlD;AACA+B,0BAAwB5B,GAAxB,EAA6BS,SAA7B,EAAwCe,WAAxC,EAAqDC,UAArD;AACD;AAED;AAEA;;;AACA,SAASI,iBAAT,CAA2B7B,GAA3B,EAAgC8B,MAAhC,EAAwC;AACtC,MAAMC,YAAYD,OAAOE,MAAP,CAAc/B,IAAd,EAAlB;;AACA,MAAI8B,UAAUE,IAAV,KAAmB,SAAvB,EAAkC;AAChC,QAAMC,YAAYlC,IAAImC,SAAJ,CAAcL,OAAOxB,EAArB,CAAlB;;AACA,QAAI4B,UAAUD,IAAV,KAAmB,SAAvB,EAAkC;AAChC;AACA,UAAMG,UAAUF,UAAUG,aAA1B,CAFgC,CAGhC;AACA;;AACA,UAAMC,QAAQF,QAAQG,gBAAR,CAAyBC,MAAzB,GAAkC,GAAhD;;AAEA,UACE,CAACT,UAAUU,OAAV,KAAsBC,SAAtB,IACCX,UAAUU,OAAV,KAAsBL,QAAQG,gBAAR,CAAyBI,OADjD,MAECZ,UAAUa,MAAV,KAAqBF,SAArB,IACCX,UAAUa,MAAV,KAAqBR,QAAQG,gBAAR,CAAyBK,MAAzB,GAAkCN,KAHzD,MAICP,UAAUc,SAAV,KAAwBH,SAAxB,IACCX,UAAUc,SAAV,KAAwBT,QAAQG,gBAAR,CAAyBM,SAAzB,GAAqCP,KAL/D,MAMCP,UAAUe,OAAV,KAAsBJ,SAAtB,IACCX,UAAUe,OAAV,KAAsBV,QAAQU,OAPhC,MAQCf,UAAUgB,aAAV,KAA4BL,SAA5B,IACCX,UAAUgB,aAAV,KAA4BX,QAAQY,mBAAR,CAA4BC,MAA5B,GAAqCX,KATnE,MAUCP,UAAUmB,cAAV,KAA6BR,SAA7B,IACCX,UAAUmB,cAAV,KAA6Bd,QAAQY,mBAAR,CAA4BL,OAX3D,CADF,EAaE;AACAT,kBAAUiB,OAAV,CAAkBpB,UAAUqB,IAA5B;AACA;AACD;AACF;AACF;;AAEDpD,MAAIqD,YAAJ,CAAiBvB,OAAOxB,EAAxB;AACAN,MAAIsD,SAAJ,CAAcxB,OAAOxB,EAArB,EAAyByB,SAAzB;AACD;;AAED,SAASH,uBAAT,CAAiC5B,GAAjC,EAAsCS,SAAtC,EAAiDe,WAAjD,EAA8DC,UAA9D,EAA0E;AAC1E;AACE;AACA;AACA,MAAIA,WAAW8B,OAAX,CAAmBlC,IAAnB,CAAwB;AAAA,WAAQmC,KAAKC,KAAL,CAAW5D,GAAX,CAAe,KAAf,CAAR;AAAA,GAAxB,CAAJ,EAA4D;AAC1DG,QAAIuB,QAAJ,CAAad,UAAUR,IAAV,EAAb;AACA;AACD;;AAPuE;AAAA;AAAA;;AAAA;AASxE,yBAAoBuB,YAAYkC,KAAhC,8HAAuC;AAAA,UAA5BA,KAA4B;AACrC1D,UAAIsD,SAAJ,CAAcI,MAAMpD,EAApB,EAAwBoD,MAAM1B,MAAN,CAAa/B,IAAb,EAAxB;AACD;AAXuE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAYxE,0BAAqBuB,YAAYM,MAAjC,mIAAyC;AAAA,UAA9BA,MAA8B;AACvCD,wBAAkB7B,GAAlB,EAAuB8B,MAAvB;AACD;AAduE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAgBxE,0BAAmBL,WAAWkC,OAA9B,mIAAuC;AAAA,UAA5BhC,IAA4B;;AACrC,UAAI3B,IAAIa,KAAJ,CAAU+C,QAAV,CAAmBjC,KAAKrB,EAAxB,CAAJ,EAAiC;AAC/BN,YAAI6D,WAAJ,CAAgBlC,KAAKrB,EAArB;AACD;AACF;AApBuE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAqBxE,0BAAqBmB,WAAW8B,OAAhC,mIAAyC;AAAA,UAA9BzB,OAA8B;;AACvC,UAAI,CAACA,QAAO4B,KAAZ,EAAmB;AACjB;AACA;AACA1D,YAAI6D,WAAJ,CAAgB/B,QAAOxB,EAAvB;AACD;;AACDN,UAAI8D,QAAJ,CAAahC,QAAO2B,KAAP,CAAaxD,IAAb,EAAb,EAAkC6B,QAAOiC,MAAzC;AACD;AA5BuE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AA8BxE,0BAAmBvC,YAAYG,IAA/B,mIAAqC;AAAA,UAA1BA,KAA0B;AACnC3B,UAAIqD,YAAJ,CAAiB1B,MAAKrB,EAAtB;AACD;AAhCuE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAiCzE;AAED;;;AACA,SAASoB,+BAAT,CAAyCsC,UAAzC,EAAqDC,UAArD,EAAiE;AAC/D,MAAMC,YAAYF,WAAWhE,GAAX,CAAe;AAAA,WAAKmE,EAAE7D,EAAP;AAAA,GAAf,CAAlB;AACA,MAAM8D,mBAAmBH,WAAWnE,MAAX,CAAkB;AAAA,WAAOoE,UAAUG,QAAV,CAAmBC,IAAIzE,GAAJ,CAAQ,QAAR,CAAnB,CAAP;AAAA,GAAlB,CAAzB;;AACA,MAAIuE,iBAAiBG,IAArB,EAA2B;AACzB;AACA,UAAM,IAAIC,KAAJ,gFAAkFJ,iBAAiBpE,GAAjB,CAAqB;AAAA,aAAKD,EAAEF,GAAF,CAAM,IAAN,CAAL;AAAA,KAArB,EAAuCI,IAAvC,GAA8CwE,IAA9C,CAAmD,EAAnD,CAAlF,EAAN;AACD;AACF","sourcesContent":["import isImmutableMap from './is-immutable-map';\nimport diffStyles from './diff-styles';\n\nexport function getInteractiveLayerIds(mapStyle) {\n  let interactiveLayerIds = null;\n\n  if (isImmutableMap(mapStyle) && mapStyle.has('layers')) {\n    interactiveLayerIds = mapStyle.get('layers')\n      .filter(l => l.get('interactive'))\n      .map(l => l.get('id'))\n      .toJS();\n  } else if (Array.isArray(mapStyle.layers)) {\n    interactiveLayerIds = mapStyle.layers.filter(l => l.interactive)\n      .map(l => l.id);\n  }\n\n  return interactiveLayerIds;\n}\n\n// Individually update the maps source and layers that have changed if all\n// other style props haven't changed. This prevents flicking of the map when\n// styles only change sources or layers.\n/* eslint-disable max-statements, complexity */\nexport function setDiffStyle(prevStyle, nextStyle, map) {\n  const prevKeysMap = prevStyle && styleKeysMap(prevStyle) || {};\n  const nextKeysMap = styleKeysMap(nextStyle);\n  function styleKeysMap(style) {\n    return style.map(() => true).delete('layers').delete('sources').toJS();\n  }\n  function propsOtherThanLayersOrSourcesDiffer() {\n    const prevKeysList = Object.keys(prevKeysMap);\n    const nextKeysList = Object.keys(nextKeysMap);\n    if (prevKeysList.length !== nextKeysList.length) {\n      return true;\n    }\n    // `nextStyle` and `prevStyle` should not have the same set of props.\n    if (nextKeysList.some(\n      key => prevStyle.get(key) !== nextStyle.get(key)\n      // But the value of one of those props is different.\n    )) {\n      return true;\n    }\n    return false;\n  }\n\n  if (!prevStyle || propsOtherThanLayersOrSourcesDiffer()) {\n    map.setStyle(nextStyle.toJS());\n    return;\n  }\n\n  const {sourcesDiff, layersDiff} = diffStyles(prevStyle, nextStyle);\n  checkForEqualLayerSourceChanges(sourcesDiff.exit, nextStyle.get('layers'));\n  applySourceLayerChanges(map, nextStyle, sourcesDiff, layersDiff);\n}\n\n/* eslint-enable max-statements, complexity */\n\n// Update a source in the map style\nfunction updateStyleSource(map, update) {\n  const newSource = update.source.toJS();\n  if (newSource.type === 'geojson') {\n    const oldSource = map.getSource(update.id);\n    if (oldSource.type === 'geojson') {\n      // update data if no other GeoJSONSource options were changed\n      const oldOpts = oldSource.workerOptions;\n      // GeoJSONSource class scales user options before assigning to workerOptions\n      // https://github.com/mapbox/mapbox-gl-js/blob/master/src/source/geojson_source.js\n      const scale = oldOpts.geojsonVtOptions.extent / 512;\n\n      if (\n        (newSource.maxzoom === undefined ||\n          newSource.maxzoom === oldOpts.geojsonVtOptions.maxZoom) &&\n        (newSource.buffer === undefined ||\n          newSource.buffer === oldOpts.geojsonVtOptions.buffer / scale) &&\n        (newSource.tolerance === undefined ||\n          newSource.tolerance === oldOpts.geojsonVtOptions.tolerance / scale) &&\n        (newSource.cluster === undefined ||\n          newSource.cluster === oldOpts.cluster) &&\n        (newSource.clusterRadius === undefined ||\n          newSource.clusterRadius === oldOpts.superclusterOptions.radius / scale) &&\n        (newSource.clusterMaxZoom === undefined ||\n          newSource.clusterMaxZoom === oldOpts.superclusterOptions.maxZoom)\n      ) {\n        oldSource.setData(newSource.data);\n        return;\n      }\n    }\n  }\n\n  map.removeSource(update.id);\n  map.addSource(update.id, newSource);\n}\n\nfunction applySourceLayerChanges(map, nextStyle, sourcesDiff, layersDiff) {\n// TODO: It's rather difficult to determine style diffing in the presence\n  // of refs. For now, if any style update has a ref, fallback to no diffing.\n  // We can come back to this case if there's a solid usecase.\n  if (layersDiff.updates.some(node => node.layer.get('ref'))) {\n    map.setStyle(nextStyle.toJS());\n    return;\n  }\n\n  for (const enter of sourcesDiff.enter) {\n    map.addSource(enter.id, enter.source.toJS());\n  }\n  for (const update of sourcesDiff.update) {\n    updateStyleSource(map, update);\n  }\n\n  for (const exit of layersDiff.exiting) {\n    if (map.style.getLayer(exit.id)) {\n      map.removeLayer(exit.id);\n    }\n  }\n  for (const update of layersDiff.updates) {\n    if (!update.enter) {\n      // This is an old layer that needs to be updated. Remove the old layer\n      // with the same id and add it back again.\n      map.removeLayer(update.id);\n    }\n    map.addLayer(update.layer.toJS(), update.before);\n  }\n\n  for (const exit of sourcesDiff.exit) {\n    map.removeSource(exit.id);\n  }\n}\n\n/* eslint-disable max-len */\nfunction checkForEqualLayerSourceChanges(sourceExit, nextLayers) {\n  const sourceIds = sourceExit.map(s => s.id);\n  const layersNotRemoved = nextLayers.filter(lyr => sourceIds.includes(lyr.get('source')));\n  if (layersNotRemoved.size) {\n    // because of this, no source/layer changes will take effect if there is an error\n    throw new Error(`You must remove any layers associated with sources you are removing: ${layersNotRemoved.map(l => l.get('id')).toJS().join('')}`);\n  }\n}\n"],"file":"style-utils.js"}