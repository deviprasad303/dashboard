{"version":3,"sources":["../../../src/components/static-map.js"],"names":["mapboxgl","isBrowser","require","TOKEN_DOC_URL","NO_TOKEN_WARNING","noop","UNAUTHORIZED_ERROR_CODE","propTypes","Object","assign","Mapbox","mapStyle","PropTypes","oneOfType","string","object","preventStyleDiffing","bool","visible","visibilityConstraints","defaultProps","childContextTypes","viewport","instanceOf","WebMercatorViewport","StaticMap","supported","props","_queryParams","componentDidMount","componentWillReceiveProps","componentDidUpdate","componentWillUnmount","state","accessTokenInvalid","getMap","bind","queryRenderedFeatures","_updateQueryParams","_updateMapSize","_updateMapStyle","_mapboxMapLoaded","_mapboxMapError","_renderNoTokenWarning","_mapbox","container","_mapboxMap","onError","toJS","_map","newProps","setProps","setState","width","height","finalize","geometry","parameters","queryParams","layers","length","interactiveLayerIds","oldProps","sizeChanged","resize","oldMapStyle","setStyle","ref","evt","statusCode","error","status","console","style","position","left","top","key","id","href","className","mapContainerStyle","viewState","visibility","overlayContainerStyle","overflow","children","PureComponent","displayName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {PureComponent, createElement} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {getInteractiveLayerIds, setDiffStyle} from '../utils/style-utils';\nimport isImmutableMap from '../utils/is-immutable-map';\n\nimport WebMercatorViewport from 'viewport-mercator-project';\n\nimport Mapbox from '../mapbox/mapbox';\nimport isBrowser from '../utils/is-browser';\nimport {checkVisibilityConstraints} from '../utils/map-constraints';\n\nconst mapboxgl = isBrowser ? require('mapbox-gl') : null;\n\n/* eslint-disable max-len */\nconst TOKEN_DOC_URL = 'https://uber.github.io/react-map-gl/#/Documentation/getting-started/about-mapbox-tokens';\nconst NO_TOKEN_WARNING = 'A valid API access token is required to use Mapbox data';\n/* eslint-disable max-len */\n\nfunction noop() {}\n\nconst UNAUTHORIZED_ERROR_CODE = 401;\n\nconst propTypes = Object.assign({}, Mapbox.propTypes, {\n  /** The Mapbox style. A string url or a MapboxGL style Immutable.Map object. */\n  mapStyle: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.object\n  ]),\n  /** There are known issues with style diffing. As stopgap, add option to prevent style diffing. */\n  preventStyleDiffing: PropTypes.bool,\n  /** Whether the map is visible */\n  visible: PropTypes.bool,\n\n  /** Advanced features */\n  // Contraints for displaying the map. If not met, then the map is hidden.\n  // Experimental! May be changed in minor version updates.\n  visibilityConstraints: PropTypes.object\n});\n\nconst defaultProps = Object.assign({}, Mapbox.defaultProps, {\n  mapStyle: 'mapbox://styles/mapbox/light-v8',\n  preventStyleDiffing: false,\n  visible: true\n});\n\nconst childContextTypes = {\n  viewport: PropTypes.instanceOf(WebMercatorViewport)\n};\n\nexport default class StaticMap extends PureComponent {\n  static supported() {\n    return mapboxgl && mapboxgl.supported();\n  }\n\n  constructor(props) {\n    super(props);\n    this._queryParams = {};\n    if (!StaticMap.supported()) {\n      this.componentDidMount = noop;\n      this.componentWillReceiveProps = noop;\n      this.componentDidUpdate = noop;\n      this.componentWillUnmount = noop;\n    }\n    this.state = {\n      accessTokenInvalid: false\n    };\n\n    this.getMap = this.getMap.bind(this);\n    this.queryRenderedFeatures = this.queryRenderedFeatures.bind(this);\n    this._updateQueryParams = this._updateQueryParams.bind(this);\n    this._updateMapSize = this._updateMapSize.bind(this);\n    this._updateMapStyle = this._updateMapStyle.bind(this);\n    this._mapboxMapLoaded = this._mapboxMapLoaded.bind(this);\n    this._mapboxMapError = this._mapboxMapError.bind(this);\n    this._renderNoTokenWarning = this._renderNoTokenWarning.bind(this);\n  }\n\n  getChildContext() {\n    return {\n      viewport: new WebMercatorViewport(this.props)\n    };\n  }\n\n  componentDidMount() {\n    const {mapStyle} = this.props;\n\n    this._mapbox = new Mapbox(Object.assign({}, this.props, {\n      mapboxgl, // Handle to mapbox-gl library\n      container: this._mapboxMap,\n      onError: this._mapboxMapError,\n      mapStyle: isImmutableMap(mapStyle) ? mapStyle.toJS() : mapStyle\n    }));\n    this._map = this._mapbox.getMap();\n    this._updateQueryParams(mapStyle);\n  }\n\n  componentWillReceiveProps(newProps) {\n    this._mapbox.setProps(newProps);\n    this._updateMapStyle(this.props, newProps);\n\n    // this._updateMapViewport(this.props, newProps);\n\n    // Save width/height so that we can check them in componentDidUpdate\n    this.setState({\n      width: this.props.width,\n      height: this.props.height\n    });\n  }\n\n  componentDidUpdate() {\n    // Since Mapbox's map.resize() reads size from DOM\n    // we must wait to read size until after render (i.e. here in \"didUpdate\")\n    this._updateMapSize(this.state, this.props);\n  }\n\n  componentWillUnmount() {\n    this._mapbox.finalize();\n    this._mapbox = null;\n    this._map = null;\n  }\n\n  // External apps can access map this way\n  getMap() {\n    return this._map;\n  }\n\n  /** Uses Mapbox's\n    * queryRenderedFeatures API to find features at point or in a bounding box.\n    * https://www.mapbox.com/mapbox-gl-js/api/#Map#queryRenderedFeatures\n    * To query only some of the layers, set the `interactive` property in the\n    * layer style to `true`.\n    * @param {[Number, Number]|[[Number, Number], [Number, Number]]} geometry -\n    *   Point or an array of two points defining the bounding box\n    * @param {Object} parameters - query options\n    */\n  queryRenderedFeatures(geometry, parameters) {\n    const queryParams = parameters || this._queryParams;\n    if (queryParams.layers && queryParams.layers.length === 0) {\n      return [];\n    }\n    return this._map.queryRenderedFeatures(geometry, queryParams);\n  }\n\n  // Hover and click only query layers whose interactive property is true\n  _updateQueryParams(mapStyle) {\n    const interactiveLayerIds = getInteractiveLayerIds(mapStyle);\n    this._queryParams = {layers: interactiveLayerIds};\n  }\n\n  // Note: needs to be called after render (e.g. in componentDidUpdate)\n  _updateMapSize(oldProps, newProps) {\n    const sizeChanged =\n      oldProps.width !== newProps.width || oldProps.height !== newProps.height;\n\n    if (sizeChanged) {\n      this._map.resize();\n      // this._callOnChangeViewport(this._map.transform);\n    }\n  }\n\n  _updateMapStyle(oldProps, newProps) {\n    const mapStyle = newProps.mapStyle;\n    const oldMapStyle = oldProps.mapStyle;\n    if (mapStyle !== oldMapStyle) {\n      if (isImmutableMap(mapStyle)) {\n        if (this.props.preventStyleDiffing) {\n          this._map.setStyle(mapStyle.toJS());\n        } else {\n          setDiffStyle(oldMapStyle, mapStyle, this._map);\n        }\n      } else {\n        this._map.setStyle(mapStyle);\n      }\n      this._updateQueryParams(mapStyle);\n    }\n  }\n\n  _mapboxMapLoaded(ref) {\n    this._mapboxMap = ref;\n  }\n\n  // Handle map error\n  _mapboxMapError(evt) {\n    const statusCode = evt.error && evt.error.status || evt.status;\n    if (statusCode === UNAUTHORIZED_ERROR_CODE && !this.state.accessTokenInvalid) {\n      // Mapbox throws unauthorized error - invalid token\n      console.error(NO_TOKEN_WARNING); // eslint-disable-line\n      this.setState({accessTokenInvalid: true});\n    }\n  }\n\n  _renderNoTokenWarning() {\n    if (this.state.accessTokenInvalid) {\n      const style = {\n        position: 'absolute',\n        left: 0,\n        top: 0\n      };\n      return (\n        createElement('div', {key: 'warning', id: 'no-token-warning', style}, [\n          createElement('h3', {key: 'header'}, NO_TOKEN_WARNING),\n          createElement('div', {key: 'text'}, 'For information on setting up your basemap, read'),\n          createElement('a', {key: 'link', href: TOKEN_DOC_URL}, 'Note on Map Tokens')\n        ])\n      );\n    }\n\n    return null;\n  }\n\n  render() {\n    const {className, width, height, style, visibilityConstraints} = this.props;\n    const mapContainerStyle = Object.assign({}, style, {width, height, position: 'relative'});\n\n    const visible = this.props.visible &&\n      checkVisibilityConstraints(this.props.viewState || this.props, visibilityConstraints);\n\n    const mapStyle = Object.assign({}, style, {\n      width,\n      height,\n      visibility: visible ? 'visible' : 'hidden'\n    });\n    const overlayContainerStyle = {\n      position: 'absolute',\n      left: 0,\n      top: 0,\n      width,\n      height,\n      overflow: 'hidden'\n    };\n\n    // Note: a static map still handles clicks and hover events\n    return (\n      createElement('div', {\n        key: 'map-container',\n        style: mapContainerStyle,\n        children: [\n          createElement('div', {\n            key: 'map-mapbox',\n            ref: this._mapboxMapLoaded,\n            style: mapStyle,\n            className\n          }),\n          createElement('div', {\n            key: 'map-overlays',\n            // Same as interactive map's overlay container\n            className: 'overlays',\n            style: overlayContainerStyle,\n            children: this.props.children\n          }),\n          this._renderNoTokenWarning()\n        ]\n      })\n    );\n  }\n}\n\nStaticMap.displayName = 'StaticMap';\nStaticMap.propTypes = propTypes;\nStaticMap.defaultProps = defaultProps;\nStaticMap.childContextTypes = childContextTypes;\n"],"file":"static-map.js"}